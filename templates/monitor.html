<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SimMonitor - Spot Vital Signs</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { background: #d1d3d4; color: #333; font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin: 0; padding: 0; width: 100vw; height: 100vh; overflow: hidden; display: flex; flex-direction: column; position: fixed; }
        
        .status-bar { height: 50px; background: #a7a9ac; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; font-size: 0.85rem; font-weight: bold; color: #333; border-bottom: 2px solid #808285; flex-shrink: 0; }
        .status-right { display: flex; align-items: center; gap: 12px; }
        
        /* Added Clock Style */
        #clock_display { font-family: monospace; font-size: 1.1rem; background: rgba(0,0,0,0.05); padding: 2px 8px; border-radius: 4px; margin-right: 10px; }

        .battery-icon { width: 28px; height: 14px; border: 2px solid #333; border-radius: 3px; position: relative; padding: 1px; }
        #batt_level { height: 100%; background: #34c759; width: 98%; border-radius: 1px; transition: width 0.5s; }
        
        .mini-btn { background: rgba(0,0,0,0.1); border: 1.5px solid rgba(0,0,0,0.15); border-radius: 6px; height: 36px; min-width: 36px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.1s, background 0.1s; }
        .mini-btn:active { transform: scale(0.92); background: rgba(0,0,0,0.3); }
        
        .power-off { background: #ff3b30; color: white; border: none; }
        .power-off:active { background: #c62828; }
        
        .main-content { padding: 10px; display: flex; flex-direction: column; gap: 8px; flex: 1; width: 100%; }
        .vital-card { background: white; border-radius: 15px; padding: 10px 20px; border: 1.5px solid #bcbec0; position: relative; display: flex; align-items: center; justify-content: center; flex: 1; min-height: 0; width: 100%; }
        .bottom-row { display: flex; gap: 8px; flex: 1.2; min-height: 0; width: 100%; }
        .bottom-row .vital-card { flex: 1; }
        
        #bp_btn { width: 150px; background: #444; color: white; border: none; border-radius: 15px; font-size: 0.95rem; font-weight: 800; cursor: pointer; padding: 10px; flex-shrink: 0; transition: transform 0.1s, background 0.1s; }
        #bp_btn:active { transform: scale(0.96); background: #222; }

        .label-group { position: absolute; top: 10px; left: 18px; display: flex; align-items: baseline; gap: 6px; }
        .row-label { font-size: 1.1rem; font-weight: 900; color: #444; text-transform: uppercase; }
        .row-unit { font-size: 0.75rem; color: #888; font-weight: 700; }
        
        /* Clinical Alarm Limits Styling */
        .alarm-limits { position: absolute; top: 10px; right: 18px; text-align: right; color: #a7a9ac; font-size: 0.7rem; font-weight: 800; line-height: 1.1; }

        .row-value { font-size: clamp(2rem, 10vh, 7rem); font-weight: 900; color: #cccccc; transition: color 0.3s; line-height: 1; text-align: center; }
        .msg-overlay { font-size: 1.2rem; font-weight: 900; color: #ff3b30; }
        
        .hr-active { color: #1b8a4d !important; }
        .spo2-active { color: #007ead !important; }
        .temp-active { color: #8e44ad !important; }
        .bp-active { color: #333 !important; }
        
        .pulse-card { display: flex; justify-content: space-between; align-items: center; padding: 10px 25px; }
        .bar-bg { height: 80%; width: 30px; background: rgba(0,0,0,0.05); border-radius: 4px; display: flex; align-items: flex-end; }
        #pulse_bar { width: 100%; height: 0%; background: #1b8a4d; transition: height 0.1s; }
        
        .blinking { animation: blink 1s linear infinite; }
        @keyframes blink { 50% { opacity: 0.3; } }
        
        /* Updated Standby Screen with Power Label */
        #standby_screen, #loading_screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #111; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; }
        .power-btn-main { width: 130px; height: 130px; border-radius: 50%; border: 4px solid #1b8a4d; background: none; color: #1b8a4d; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; margin-bottom: 10px; }
        .power-btn-main:active { background: #1b8a4d; color: white; transform: scale(0.9); }
        .power-text { color: #1b8a4d; font-weight: 900; letter-spacing: 4px; font-size: 0.8rem; }
        
        .progress-container { width: 300px; height: 12px; background: #333; border-radius: 6px; margin-top: 25px; overflow: hidden; }
        .progress-bar-fill { width: 0%; height: 100%; background: #0fec7d; transition: width 3s linear; }
    </style>
</head>
<body>

<div class="status-bar">
    <div style="display: flex; align-items: center; gap: 10px;">
        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12.55a11 11 0 0 1 14.08 0"></path><path d="M1.42 9a16 16 0 0 1 21.16 0"></path><path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path><line x1="12" y1="20" x2="12.01" y2="20"></line></svg>
        <span id="sys_status_text" style="font-size: 0.9rem;">SYSTEM READY</span>
    </div>
    
    <div class="status-right">
        <div id="clock_display">00:00</div>
        <button class="mini-btn" id="mute_btn" onclick="toggleMute()" style="min-width: 44px;">
            <svg id="vol_icon" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
        </button>
        <div class="battery-icon"><div id="batt_level"></div></div>
        <button class="mini-btn power-off" id="mon_power_btn" onclick="location.reload()">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path><line x1="12" y1="2" x2="12" y2="12"></line></svg>
        </button>
    </div>
</div>

<div id="standby_screen">
    <button class="power-btn-main" id="start_btn" onclick="startBoot()">
        <svg viewBox="0 0 24 24" width="70" height="70" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path><line x1="12" y1="2" x2="12" y2="12"></line></svg>
    </button>
    <div class="power-text">POWER</div>
</div>

<div id="loading_screen" style="display:none; color:white; font-weight: bold; letter-spacing: 2px;">
    INITIALIZING...
    <div class="progress-container"><div class="progress-bar-fill" id="p_bar"></div></div>
</div>

<div class="main-content">
    <div class="vital-card">
        <div class="label-group"><span class="row-label">SYS</span><span class="row-unit">mmHg</span></div>
        <div class="alarm-limits">140<br>90</div>
        <div class="row-value" id="sys_v">---</div>
    </div>
    <div class="vital-card">
        <div class="label-group"><span class="row-label">DIA</span><span class="row-unit">mmHg</span></div>
        <div class="alarm-limits">90<br>60</div>
        <div class="row-value" id="dia_v">---</div>
    </div>
    <div class="vital-card">
        <div class="label-group"><span class="row-label">SpO2</span><span class="row-unit">%</span></div>
        <div class="alarm-limits"><br>90</div>
        <div class="row-value" id="spo2_v">---</div>
    </div>
    <div class="vital-card pulse-card">
        <div class="label-group"><span class="row-label">Pulse</span><span class="row-unit">bpm</span></div>
        <div class="alarm-limits">120<br>50</div>
        <div class="row-value" id="hr_v">---</div>
        <div class="bar-bg"><div id="pulse_bar"></div></div>
    </div>
    <div class="bottom-row">
        <div class="vital-card">
            <div class="label-group"><span class="row-label">Temp</span><span class="row-unit">Â°C</span></div>
            <div class="row-value" id="temp_v">--.-</div>
        </div>
        <button id="bp_btn" onclick="runBP()">START BP CYCLE</button>
    </div>
</div>

<script>
    var socket = io({ transports: ['websocket'], upgrade: false });

    let targetHR = 60, targetSpO2 = 98, t_sys = 120, t_dia = 80;
    let hr_on = false, spo2_on = false, bp_attached = false, cycling = false, signalQuality = 'normal';
    let hrDrift = 0, spo2Drift = 0;
    let masterVolume = 0.5; 
    let isMuted = false;
    let isLoopRunning = false;

    const urlParams = new URLSearchParams(window.location.search);
    const roomCode = urlParams.get('room');
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    // 1. Clock Logic
    function updateClock() {
        const now = new Date();
        document.getElementById('clock_display').innerText = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');
    }
    setInterval(updateClock, 1000);
    updateClock();

    // 2. Fullscreen Logic
    function startBoot() {
        // Trigger Fullscreen
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(err => {
                console.log("Fullscreen blocked or not supported");
            });
        }

        if (audioCtx.state === 'suspended') audioCtx.resume();
        document.getElementById('standby_screen').style.display = 'none';
        document.getElementById('loading_screen').style.display = 'flex';
        socket.emit('monitor_powered_on', { room: roomCode });
        setTimeout(() => { document.getElementById('p_bar').style.width = '100%'; }, 100);
        setTimeout(() => {
            document.getElementById('loading_screen').style.display = 'none';
            runAnimationLoop(); 
            startDriftTimer();
        }, 3000); 
    }

    socket.on('connect', () => {
        socket.emit('join', { room: roomCode, type: 'monitor' });
    });

    function toggleMute() {
        isMuted = !isMuted;
        const icon = document.getElementById('vol_icon');
        if(isMuted) {
            icon.innerHTML = '<line x1="1" y1="1" x2="23" y2="23"></line><path d="M9 9l-5 5H2v-4h2l5-5z"></path><path d="M11 5v14"></path>';
        } else {
            icon.innerHTML = '<polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>';
        }
    }

    function updateDisplay() {
        const hrEl = document.getElementById('hr_v');
        const spo2El = document.getElementById('spo2_v');
        const sysEl = document.getElementById('sys_v');
        const diaEl = document.getElementById('dia_v');

        if (hr_on) {
            let dHR = Math.max(0, parseInt(targetHR) + hrDrift);
            hrEl.innerText = (targetHR > 0) ? dHR : 0;
            hrEl.className = "row-value hr-active";
            
            let dSPO2 = Math.min(100, Math.max(0, parseInt(targetSpO2) + spo2Drift));
            spo2El.innerText = (targetHR > 0) ? dSPO2 : 0;
            spo2El.className = "row-value spo2-active";
        } else {
            hrEl.innerText = "CONNECT SENSOR";
            hrEl.className = "row-value msg-overlay";
            spo2El.innerText = "CONNECT SENSOR";
            spo2El.className = "row-value msg-overlay";
        }

        // Handle BP state visibility
        if (!bp_attached && !cycling) {
            sysEl.innerText = "ATTACH CUFF";
            sysEl.className = "row-value msg-overlay";
            diaEl.innerText = "ATTACH CUFF";
            diaEl.className = "row-value msg-overlay";
        }
    }

    function playBeep() {
        if (!hr_on || targetHR <= 0 || isMuted) return;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        let freq = (hr_on && spo2_on) ? 400 + (targetSpO2 * 5.6) : 800;
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gain.gain.setValueAtTime(0.0001, audioCtx.currentTime);
        gain.gain.linearRampToValueAtTime(masterVolume * 0.1, audioCtx.currentTime + 0.02);
        gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.12);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + 0.15);
    }

    function runAnimationLoop() {
        if (isLoopRunning) return;
        isLoopRunning = true;
        const animate = () => {
            if(hr_on && targetHR > 0) {
                let h = (signalQuality === 'poor') ? (Math.random() * 45 + 15) + "%" : "100%";
                const bar = document.getElementById('pulse_bar');
                if (bar) bar.style.height = h;
                playBeep();
                setTimeout(() => { if (bar) bar.style.height = "0%"; }, 150);
                let interval = (60 / targetHR) * 1000;
                setTimeout(animate, interval);
            } else {
                const bar = document.getElementById('pulse_bar');
                if (bar) bar.style.height = "0%";
                setTimeout(animate, 1000);
            }
        };
        animate();
    }

    function startDriftTimer() {
        setInterval(() => {
            if (hr_on && targetHR > 0) {
                hrDrift = Math.floor(Math.random() * 5) - 2;
                spo2Drift = Math.floor(Math.random() * 3) - 1;
                updateDisplay();
            }
        }, 10000);
    }

    socket.on('update_vitals', (data) => {
        if (data.type === 'vitals') {
            targetHR = data.hr; targetSpO2 = data.spo2;
            hr_on = data.hr_conn; spo2_on = data.spo2_conn;
            signalQuality = data.signal_quality || 'normal';
            updateDisplay(); 
        } else if (data.type === 'system_reset') {
            location.reload();
        } else if (data.type === 'push_temp') {
            document.getElementById('temp_v').innerText = parseFloat(data.temp).toFixed(1);
            document.getElementById('temp_v').className = "row-value temp-active";
        } else if (data.type === 'set_target_bp') {
            t_sys = data.sys; t_dia = data.dia;
            bp_attached = data.bp_conn;
            updateDisplay();
        }
    });

    function runBP() {
        if (cycling || !bp_attached) return; 
        cycling = true;
        const btn = document.getElementById('bp_btn');
        btn.innerText = "INFLATING...";
        document.getElementById('sys_v').innerText = "---";
        document.getElementById('dia_v').innerText = "---";
        document.getElementById('sys_v').className = "row-value blinking";
        document.getElementById('dia_v').className = "row-value blinking";
        
        setTimeout(() => {
            document.getElementById('sys_v').classList.remove('blinking');
            document.getElementById('dia_v').classList.remove('blinking');
            document.getElementById('sys_v').innerText = t_sys;
            document.getElementById('dia_v').innerText = t_dia;
            document.getElementById('sys_v').className = "row-value bp-active";
            document.getElementById('dia_v').className = "row-value bp-active";
            btn.innerText = "START BP CYCLE"; cycling = false;
        }, 8000);
    }
</script>
</body>
</html>
